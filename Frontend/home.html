<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Clinical Trial Management</title>
    <link rel="stylesheet" href="styles.css">
    <script src="auth-helper.js"></script>
</head>
<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Clinical Trial Management System</span>
        </div>
    </header>
    <nav>
        <a href="home.html" class="active">Home</a>
        <a href="patients.html">View Patients</a>
        <a href="add_patient.html" id="nav-add-patient">Add Patient</a>
        <a href="eligibility.html">Check Eligibility</a>
        <a href="modify_patient.html" id="nav-modify-patient">Modify Patients</a>
        <a href="users.html">Users & Roles</a>
        <a href="reports.html">Reports</a>
    </nav>
    <main>
        <h2>Welcome to Clinical Trial Management System</h2>
        
        <div id="user-info" style="background: #e7f3ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #005b96;">
            <h3 style="margin-top: 0;">User Profile</h3>
            <p><strong>Name:</strong> <span id="profile-name"></span></p>
            <p><strong>Username:</strong> <span id="profile-username"></span></p>
            <p><strong>Email:</strong> <span id="profile-email"></span></p>
            <p><strong>Role(s):</strong> <span id="profile-roles"></span></p>
        </div>

        <div id="permissions-info" style="background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #28a745;">
            <h3 style="margin-top: 0;">Your Permissions</h3>
            <ul id="permissions-list"></ul>
        </div>

        <h3>Quick Actions</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
            <div class="action-card">
                <h4>View Patients</h4>
                <p>Browse all patients and their statistics</p>
                <a href="patients.html"><button>View Patients</button></a>
            </div>

            <div class="action-card" id="card-add-patient">
                <h4>Add Patient</h4>
                <p>Register a new patient in the system</p>
                <a href="add_patient.html"><button>Add Patient</button></a>
            </div>

            <div class="action-card">
                <h4>Check Eligibility</h4>
                <p>Check patient eligibility for trials</p>
                <a href="eligibility.html"><button>Check Eligibility</button></a>
            </div>

            <div class="action-card" id="card-modify-patient">
                <h4>Modify Patients</h4>
                <p>Update or delete patient records</p>
                <a href="modify_patient.html"><button>Modify Patients</button></a>
            </div>

            <div class="action-card">
                <h4>Users & Roles</h4>
                <p>Manage user accounts and permissions</p>
                <a href="users.html"><button>Users & Roles</button></a>
            </div>

            <div class="action-card">
                <h4>Reports</h4>
                <p>View system analytics and reports</p>
                <a href="reports.html"><button>View Reports</button></a>
            </div>
        </div>

        <h3>System Statistics</h3>
        <div id="loading-stats" class="loading">Loading statistics...</div>
        <div id="stats-content" style="display: none;">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Total Patients</th>
                        <th>Active Trials</th>
                        <th>Medical Conditions</th>
                        <th>Medications</th>
                        <th>System Users</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="stat-patients">0</td>
                        <td id="stat-trials">0</td>
                        <td id="stat-conditions">0</td>
                        <td id="stat-medications">0</td>
                        <td id="stat-users">0</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <style>
        .action-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e3e7ea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .action-card h4 {
            margin: 0 0 10px 0;
            color: #005b96;
        }

        .action-card p {
            color: #666;
            font-size: 14px;
            margin: 0 0 15px 0;
        }

        .action-card button {
            width: 100%;
        }

        .action-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        // Check authentication
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            if (isAuthenticated !== 'true') {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Load user profile
        function loadUserProfile() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            
            if (!currentUser.username) {
                window.location.href = 'index.html';
                return;
            }

            // Display user info
            // document.getElementById('user-welcome').textContent = `Welcome, ${currentUser.firstName}!`;
            document.getElementById('profile-name').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('profile-username').textContent = currentUser.username;
            document.getElementById('profile-email').textContent = currentUser.email;
            
            // Display roles
            const roles = currentUser.roles || [];
            let roleNames = roles.map(r => r.roleName).join(', ');
            
            // Special handling for admin
            if (currentUser.username === 'admin') {
                roleNames = roleNames || 'Administrator';
            }
            
            document.getElementById('profile-roles').textContent = roleNames || 'No roles assigned';

            // Display permissions
            const permissionsList = document.getElementById('permissions-list');
            permissionsList.innerHTML = '';

            // Check if admin by username
            if (isAdmin()) {
                permissionsList.innerHTML = `
                    <li><strong>Administrator - Full Access</strong></li>
                    <li>Can add patients</li>
                    <li>Can view trials</li>
                    <li>Can manage trials</li>
                    <li>Can view reports</li>
                    <li>Can manage users</li>
                `;
            } else {
                let hasPermissions = false;
                
                // Check permissions from roles
                if (hasPermission('canAddPatients')) {
                    permissionsList.innerHTML += '<li>✓ Can add patients</li>';
                    hasPermissions = true;
                }
                if (hasPermission('canViewTrials')) {
                    permissionsList.innerHTML += '<li>✓ Can view trials</li>';
                    hasPermissions = true;
                }
                if (hasPermission('canManageTrials')) {
                    permissionsList.innerHTML += '<li>✓ Can manage trials</li>';
                    hasPermissions = true;
                }
                if (hasPermission('canViewReports')) {
                    permissionsList.innerHTML += '<li>✓ Can view reports</li>';
                    hasPermissions = true;
                }

                if (!hasPermissions) {
                    permissionsList.innerHTML = '<li>No special permissions</li>';
                }
            }

            // Hide actions based on permissions
            const canAddPatients = isAdmin() || hasPermission('canAddPatients');
            if (!canAddPatients) {
                document.getElementById('card-add-patient').classList.add('disabled');
                document.getElementById('card-modify-patient').classList.add('disabled');
                document.getElementById('nav-add-patient').style.display = 'none';
                document.getElementById('nav-modify-patient').style.display = 'none';
            }
        }

        // Load system statistics
        async function loadStatistics() {
            try {
                const [patientsResp, trialsResp, conditionsResp, medicationsResp, usersResp] = await Promise.all([
                    fetch(`${API_BASE}/patients`),
                    fetch(`${API_BASE}/trials`),
                    fetch(`${API_BASE}/conditions`),
                    fetch(`${API_BASE}/medications`),
                    fetch(`${API_BASE}/users`)
                ]);

                const patients = await patientsResp.json();
                const trials = await trialsResp.json();
                const conditions = await conditionsResp.json();
                const medications = await medicationsResp.json();
                const users = await usersResp.json();

                document.getElementById('stat-patients').textContent = patients.length;
                document.getElementById('stat-trials').textContent = trials.length;
                document.getElementById('stat-conditions').textContent = conditions.length;
                document.getElementById('stat-medications').textContent = medications.length;
                document.getElementById('stat-users').textContent = users.length;

                document.getElementById('loading-stats').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';

            } catch (error) {
                document.getElementById('loading-stats').textContent = 'Failed to load statistics';
            }
        }

        // Initialize
        if (checkAuth()) {
            loadUserProfile();
            loadStatistics();
        }
    </script>
</body>
</html>